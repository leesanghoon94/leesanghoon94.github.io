iptables chains and tables in linux

1. 개요
   iptables 명령어 Tables 과 chains차이
   패킷이 이러한 테이블과 체인 사이를 통과하는 방법.

2. firewall components
   Linux에는 iptables 및 netfilter와 같은 방화벽 메커니즘을 제공하는 몇 가지 부분이 있습니다. netfilter 프레임워크와 iptables 명령 간의 관계를 이해하는 것은 시스템에 설정한 방화벽 규칙에 따라 패킷이 처리되는 방식을 이해하는 데 필수적입니다.

2.1. iptables 및 넷필터
첫째, netfilter 프레임워크는 방화벽의 기반을 제공하는 커널의 인프라입니다. 특히 netfilter는 패킷 이동의 여러 부분에서 트리거되는 5개의 서로 다른 후크를 제공합니다. 예를 들어, 들어오는 트래픽이 네트워크 스택에 처음 들어갈 때 NF_IP_PRE_ROUTING 후크가 트리거됩니다.

그런 다음 다양한 프로그램에서 이 5개 후크를 사용하여 처리 기능을 등록하여 패킷에 대한 필터링이나 맹글링을 수행할 수 있습니다. ip_tables는 netfilter 후크에 다양한 테이블과 체인을 등록하는 커널 모듈 중 하나입니다. 이렇게 하면 다른 netfilter 후크가 트리거될 때 ip_tables 모듈에 알림이 전달되고 해당 패킷에 대한 작업이 수행될 수 있습니다.

그런 다음 널리 사용되는 iptables 명령은 ip_tables 커널 모듈의 다양한 테이블과 체인을 관리하기 위한 사용자 공간 도구입니다.

iptables 명령어에 chains, tables의 뜻

2.2. 규칙과 체인
방화벽의 가장 낮은 수준에서 규칙은 기본 구성 요소 역할을 합니다. 패킷 거부, 삭제, 로깅 또는 변조와 같은 패킷에 대한 다양한 작업을 수행하는 규칙을 정의할 수 있습니다. 예를 들어 iptables 명령어를 사용하면 DROP 구문을 사용하여 포트 22를 대상으로 하는 모든 수신 패킷을 거부하는 규칙을 정의할 수 있습니다.

그런 다음 이러한 규칙을 결합하여 체인을 형성할 수 있습니다. 패킷이 체인을 통과할 때 체인의 다양한 규칙에 따라 패킷이 순차적으로 처리됩니다. 규칙 중 하나라도 패킷을 거부하거나 거부하면 시스템의 해당 지점에서 패킷 이동이 종료됩니다.

2.3. 테이블
우리가 정의한 다양한 체인은 차례로 테이블의 기초를 형성합니다. iptables 명령어에는 nat, mangle, filter 테이블이 있습니다. 이름에서 알 수 있듯이 각 테이블은 통과하는 패킷에 대해 서로 다른 작업을 수행하는 서로 다른 체인으로 구성됩니다.

예를 들어, 필터 테이블에는 다음을 기준으로 패킷을 필터링하는 규칙을 정의하는 체인이 포함되어 있습니다. 그들의 속성. 우리는 일반적으로 필터 테이블을 사용하여 트래픽을 차단하거나 허용하는 규칙을 정의합니다.

반면 nat 테이블은 패킷에 대해 NAT(네트워크 주소 변환)를 수행하는 체인을 정의합니다.

맹글 테이블은 여정의 다양한 지점에서 패킷을 수정하는 규칙으로 구성됩니다. 예를 들어, 맹글 테이블에 규칙을 정의하여 패킷의 TTL(Time to Live) 값을 수정할 수 있습니다. 이러한 수정을 통해 헤더를 수정하여 패킷이 취하는 경로를 변경할 수 있습니다.

이러한 모든 테이블과 체인을 통해 방화벽 구성 오류를 방지하기 위해 패킷이 네트워크 스택을 통과하는 방법을 이해해야 합니다. 다음 섹션에서는 다양한 테이블과 체인에 걸친 패킷의 통과 경로에 대해 자세히 살펴보겠습니다.

3. 패킷 순회
   일반적으로 시나리오에 따라 패킷이 사용할 수 있는 경로는 세 가지입니다. 첫째, 패킷은 대상이 로컬 프로세스로 설정된 시스템 외부에서 올 수 있습니다. 반면에 로컬 프로세스는 다른 원격 호스트로 전달될 나가는 패킷을 생성할 수 있습니다. 마지막으로 시스템은 로컬 프로세스용이 아닌 패킷을 수신할 수 있으므로 다른 호스트로 전달해야 합니다.

모든 다른 경로는 다른 순서로 다른 iptables 체인과 테이블에 도달합니다.

3.1. 로컬 프로세스로 들어오는 패킷
패킷이 네트워크 인터페이스로 들어오면 패킷은 먼저 맹글 테이블의 PREROUTING 체인에 도달합니다. 이 체인은 일반적으로 패킷이 나머지 체인으로 전송되기 전에 패킷의 헤더 값을 변경하는 데 사용됩니다.

그 후, nat 테이블의 PREROUTING 체인이 패킷에 대해 작동하여 패킷에 대한 대상 네트워크 주소 변환(DNAT)을 수행합니다. DNAT는 추가 라우팅을 위해 패킷의 대상 IP 주소를 개인 IP 주소로 변환합니다.

mangle 및 nat 테이블에서 PREROUTING 체인을 실행한 후 커널은 이 패킷에 대한 라우팅 결정을 수행합니다. 이 시점에서 패킷은 정방향 패킷 경로를 사용하여 다른 호스트로 전달되거나 패킷이 로컬 프로세스로 전달될 수 있습니다. 후자의 경우 패킷은 맹글 테이블의 INPUT 체인으로 전달됩니다.

맹글 테이블의 INPUT 체인은 패킷에 대한 맹글링 작업 목록을 정의합니다. 로컬 프로세스.

다음으로 패킷은 필터 테이블의 INPUT 체인에 도달합니다. 이는 패킷 삭제 또는 거부에 대한 모든 규칙이 상주하는 체인입니다. 패킷이 전체 통과에서 살아남으면 최종적으로 추가 처리를 위해 로컬 프로세스에 도달하게 됩니다.

3.2. 로컬 프로세스에서 나가는 패킷
호스트를 떠나는 나가는 패킷의 경우 먼저 맹글 테이블의 OUTPUT 체인에 도달합니다. 그런 다음 패킷은 nat 테이블의 OUTPUT 체인으로 이동합니다.

두 출력 체인 모두 패킷을 처리한 후 커널은 패킷에 대한 라우팅 결정을 내립니다. 이는 체인이 패킷의 대상을 변경했을 수 있기 때문입니다.

라우팅 결정 후 시스템을 떠나는 패킷의 경우 필터 테이블의 OUTPUT 체인을 통과합니다. 필터 테이블의 OUTPUT 체인을 통해 모든 나가는 패킷이 신뢰할 수 있는 호스트만을 대상으로 하는지 확인하는 규칙을 유지할 수 있습니다.

패킷이 필터 테이블의 OUTPUT 체인에서 살아남으면 커널은 mangle 테이블과 nat 테이블의 POSTROUTING 체인을 순서대로 통과하여 패킷을 전달합니다. 여기서 nat 테이블의 출력 체인이 수행하는 주요 작업은 소스 네트워크 주소 변환(SNAT)입니다. SNAT는 패킷의 소스 IP 주소가 개인 네트워크 주소 대신 네트워크 인터페이스의 공용 주소로 업데이트되도록 합니다.

3.3. 전달된 패킷
전달될 패킷의 경우 이동의 첫 번째 구간은 수신 패킷과 동일합니다. 구체적으로, 패킷은 커널이 라우팅 결정을 수행하기 전에 mangle 및 nat 테이블의 PREROUTING 체인에 도달합니다.

라우팅 결정 후 전달될 모든 패킷은 맹글 테이블의 FORWARD 체인에 의해 평가됩니다. 우리는 이 체인에서 패킷 전달을 구체적으로 목표로 삼는 맹글링 작업을 정의할 수 있습니다.

그런 다음 패킷은 필터 테이블의 FORWARD 체인에 도달합니다. 필터 테이블의 다른 체인과 마찬가지로 전달 경로에서 원치 않는 패킷을 삭제하거나 거부하는 규칙을 정의할 수 있습니다.

남아 있는 모든 패킷은 각각 mangle 테이블과 nat 테이블의 POSTROUTING 체인에 의해 처리됩니다. nat 테이블의 POSTROUTING 체인은 SNAT를 수행하여 소스 IP 주소를 비공개 IP 주소에서 공개 주소로 변환하는 역할을 합니다.

3.4. 여정 요약
ASCII 다이어그램을 사용하여 패킷의 이동을 시각화할 수 있습니다.

```
[network interface]
        |
        |
        v                                               <incoming packet>
  PREROUTING (mangle) --> PREROUTING (nat) --> [routing] -----------> INPUT (mangle) --> INPUT (filter) --> [local process]
                                                   |                                                              |
                               <forwarding packet> |                                                              | <outgoing packet>
                                                   v                                                              v
                                           FORWARD (mangle)                                                 OUTPUT (mangle)
                                                   |                                                              |
 	                                           |                                                              |
                                                   v                                                              v
                                             FORWARD (filter)                                                 OUTPUT (nat)
                                                   |                                                              |
                                                   |                                                              |
                                                   |                                                              v
                                                   |                                                           [routing]
                                                   |                                                              |
                                                   |                                                              |
                                                   |                                                              v
                                                   |                                                           OUTPUT (filter)
                                                   |                                                              |
                                                   |                                                              |
                                                   |                                                              v
                                                   └----------------------------------------------------> POSTROUTING (mangle)
                                                                                                                  |
                                                                                                                  |
                                                                                                                  v
                                                                                                            POSTROUTING (nat)
                                                                                                                  |
                                                                                                                  |
                                                                                                                  v
                                                                                                          [network interface]

```

다이어그램에서 우리는 몇 가지 흥미로운 점을 관찰할 수 있습니다. 첫째, 맹글링 체인은 항상 세 가지 다른 경로 모두에서 패킷을 먼저 처리합니다. 맹글링 직후 nat 테이블의 체인이 작동하여 주소가 올바른지 확인합니다.

경험상 후크는 라우팅 결정 전에 PREROUTING 체인을 트리거합니다. 이는 패킷 라우팅을 유연하게 사용자 정의할 수 있도록 하기 위한 것입니다. 반대로, 후크는 항상 패킷이 호스트를 떠나기 직전에 POSTROUTING 체인을 트리거합니다.

흥미롭게도 필터 테이블의 체인은 mangle 및 nat 체인이 패킷을 처리한 후에 항상 패킷을 확인합니다. 따라서 필터 테이블의 규칙은 항상 변조 후, 변환 후 패킷 상태에서 작동합니다.

4. 결론
   이 튜토리얼에서는 iptables 명령어의 개요를 살펴보았습니다. 그런 다음 iptables 명령어의 맥락에서 규칙, 체인, 테이블의 차이점에 대해서도 배웠습니다.

그 후, 우리는 다양한 테이블과 체인 간의 패킷 통과 주제에 대해 자세히 살펴보았습니다. 구체적으로, 들어오는 패킷, 나가는 패킷 및 전달할 패킷이 취하는 경로를 자세히 설명했습니다.

상황에 따라 패킷이 이동하는 정확한 경로를 이해함으로써 시스템을 보호하기 위한 더 나은 방화벽 규칙을 구축할 수 있습니다. 중요한 것은 다양한 테이블과 체인 간의 상호 작용을 이해함으로써 방화벽 설정에 문제가 발생할 때 어떤 체인을 살펴봐야 하는지 알 수 있다는 것입니다.
